name: Mobile Build (EAS)

on:
  push:
    branches: [main]
    paths:
      - 'mobile/**'
      - 'mobile-lite/**'

jobs:
  build:
    name: EAS Build (iOS + Android)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies (mobile)
        run: |
          cd mobile && npm install --legacy-peer-deps 2>/dev/null || \
          cd ../mobile-lite && npm install --legacy-peer-deps 2>/dev/null || true

      - name: EAS Build
        run: |
          if [ -d "mobile" ]; then
            cd mobile && eas build --platform all --profile preview --non-interactive
          elif [ -d "mobile-lite" ]; then
            cd mobile-lite && eas build --platform all --profile preview --non-interactive
          fi

      - name: Notify Telegram
        if: always()
        run: |
          STATUS=${{ job.status }}
          REPO=${{ github.repository }}
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="5262081689" \
            -d text="ðŸ“± Mobile build ${STATUS} â€” ${REPO} ($(git log -1 --pretty='%s'))"
